{{!-- loan.hbs --}}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{title}}</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    .loan-thumbnail {
      max-height: 80px;
      width: auto;
      border-radius: 4px;
    }
    .loan-table td, .loan-table th {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">Maximum Gamers</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/loans">My Loans</a>
          </li>
          <li class="nav-item">
            <span class="nav-link">{{user.name}}</span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Intro -->
    <div class="mb-4">
      <h2>Welcome, {{user.name}}!</h2>
      <p>
        Here you can view all your loan applications, apply for new loans,
        and track their current status in real time. Amounts are shown in
        Kenyan Shillings (KSH), and loan periods are displayed in months.
      </p>
    </div>

    <!-- Loan Submission Form -->
    <div class="card mb-4">
      <div class="card-header">Apply for a New Loan</div>
      <div class="card-body">
        <form id="loanForm" action="/loans" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="description" class="form-label">Item Description</label>
            <input type="text" class="form-control" id="description" name="description" required />
          </div>
          <div class="mb-3">
            <label for="itemValue" class="form-label">Item Value (KSH)</label>
            <input type="number" class="form-control" id="itemValue" name="itemValue" min="0" required />
          </div>
          <div class="mb-3">
            <label for="loanAmount" class="form-label">Loan Amount (KSH)</label>
            <input type="number" class="form-control" id="loanAmount" name="loanAmount" min="0" required />
          </div>
          <div class="mb-3">
            <label for="loanPeriod" class="form-label">Loan Period (Months)</label>
            <input type="number" class="form-control" id="loanPeriod" name="loanPeriod" min="1" required />
          </div>
          <div class="mb-3">
            <label for="itemImage" class="form-label">Item Image</label>
            <input class="form-control" type="file" id="itemImage" name="itemImage" accept="image/*" />
          </div>
          <button type="submit" class="btn btn-primary">Submit Loan</button>
        </form>
      </div>
    </div>

    <!-- Loan History Table -->
    <div class="card">
      <div class="card-header">My Loan History</div>
      <div class="card-body table-responsive">
        <table class="table table-bordered table-hover loan-table" id="loanTable">
          <thead class="table-dark">
            <tr>
              <th>Item</th>
              <th>Description</th>
              <th>Item Value (KSH)</th>
              <th>Loan Amount (KSH)</th>
              <th>Loan Period (Months)</th>
              <th>Status</th>
              <th>Applied On</th>
            </tr>
          </thead>
          <tbody>
            {{#each loans}}
              <tr id="loan-{{_id}}">
                <td>
                  {{#if itemImage}}
                    <img src="{{itemImage}}" class="loan-thumbnail" alt="Item Image">
                  {{else}}
                    N/A
                  {{/if}}
                </td>
                <td>{{description}}</td>
                <td>{{itemValue}}</td>
                <td>{{loanAmount}}</td>
                <td>{{loanPeriod}}</td>
                <td>
                  {{#ifEquals status "Pending"}}
                    <span class="badge bg-warning text-dark">{{status}}</span>
                  {{else ifEquals status "Approved"}}
                    <span class="badge bg-success">{{status}}</span>
                  {{else ifEquals status "Rejected"}}
                    <span class="badge bg-danger">{{status}}</span>
                  {{else}}
                    <span class="badge bg-secondary">{{status}}</span>
                  {{/ifEquals}}
                </td>
                <td>{{formatDate createdAt}}</td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
      return new Date(dateString).toLocaleString('en-GB', options);
    }

    // Add new loan to table with image thumbnail
    socket.on("loanCreated", (loan) => {
      const tableBody = document.querySelector("#loanTable tbody");
      const row = document.createElement("tr");
      row.id = "loan-" + loan._id;
      row.innerHTML = `
        <td>${loan.itemImage ? `<img src="${loan.itemImage}" class="loan-thumbnail" alt="Item Image">` : "N/A"}</td>
        <td>${loan.description}</td>
        <td>${loan.itemValue}</td>
        <td>${loan.loanAmount}</td>
        <td>${loan.loanPeriod}</td>
        <td><span class="badge bg-warning text-dark">${loan.status}</span></td>
        <td>${formatDate(loan.createdAt)}</td>
      `;
      tableBody.prepend(row);
    });

    // Update loan status
    socket.on("loanUpdated", (loan) => {
      const row = document.getElementById("loan-" + loan._id);
      if (row) {
        const badge = row.querySelector("td:nth-child(6) span");
        badge.textContent = loan.status;
        if (loan.status === "Pending") badge.className = "badge bg-warning text-dark";
        else if (loan.status === "Approved") badge.className = "badge bg-success";
        else if (loan.status === "Rejected") badge.className = "badge bg-danger";
        else badge.className = "badge bg-secondary";
      }
    });
  </script>
</body>
</html>


